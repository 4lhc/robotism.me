<!DOCTYPE HTML>
<!--
	Massively by HTML5 UP
	html5up.net | @ajlkn
  Jekyll integration by somiibo.com
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
	<head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />

<title>Controlling ROS Turtlebot3 with Miband - Part II</title>
<meta name="description" content="">

<link rel="apple-touch-icon" sizes="180x180" href="https://robotism.me/assets/icon/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://robotism.me/assets/icon/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="https://robotism.me/assets/icon/favicon-16x16.png">
<link rel="manifest" href="https://robotism.me/assets/icon/manifest.json">
<link rel="mask-icon" href="https://robotism.me/assets/icon/safari-pinned-tab.svg" color="#5bbad5">
<link rel="shortcut icon" href="https://robotism.me/assets/icon/favicon.ico">
<meta name="msapplication-config" content="https://robotism.me/assets/icon/browserconfig.xml">
<meta name="theme-color" content="#ffffff">

<!-- CSS -->
<link rel="stylesheet" href="https://robotism.me/assets/css/main.css" />
<noscript><link rel="stylesheet" href="https://robotism.me/assets/css/noscript.css" /></noscript>
<!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Controlling ROS Turtlebot3 with Miband - Part II | Robotism</title>
<meta name="generator" content="Jekyll v3.6.3" />
<meta property="og:title" content="Controlling ROS Turtlebot3 with Miband - Part II" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Coding a Xiaomi Miband Controller for ROS Gazebo Turtlebot3 simulation." />
<meta property="og:description" content="Coding a Xiaomi Miband Controller for ROS Gazebo Turtlebot3 simulation." />
<link rel="canonical" href="https://robotism.me/blog/controlling-ROS-robot-with-miband-hrx-2/" />
<meta property="og:url" content="https://robotism.me/blog/controlling-ROS-robot-with-miband-hrx-2/" />
<meta property="og:site_name" content="Robotism" />
<meta property="og:image" content="https://robotism.me/images/controlling-ROS-robot-with-miband-hrx-2-img01.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-09-14T00:00:00+05:30" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://robotism.me/images/controlling-ROS-robot-with-miband-hrx-2-img01.png" />
<meta property="twitter:title" content="Controlling ROS Turtlebot3 with Miband - Part II" />
<meta name="twitter:site" content="@" />
<script type="application/ld+json">
{"@type":"BlogPosting","headline":"Controlling ROS Turtlebot3 with Miband - Part II","dateModified":"2019-09-14T00:00:00+05:30","datePublished":"2019-09-14T00:00:00+05:30","mainEntityOfPage":{"@type":"WebPage","@id":"https://robotism.me/blog/controlling-ROS-robot-with-miband-hrx-2/"},"image":"https://robotism.me/images/controlling-ROS-robot-with-miband-hrx-2-img01.png","description":"Coding a Xiaomi Miband Controller for ROS Gazebo Turtlebot3 simulation.","url":"https://robotism.me/blog/controlling-ROS-robot-with-miband-hrx-2/","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


	</head>
	<body class="is-loading">

		<!-- Wrapper -->
			<div id="wrapper" class="fade-in">

				<!-- Header -->
        <header id="header">
          <a href="https://robotism.me/" class="logo">Robotism</a>
        </header>

				<!-- Nav -->
					<nav id="nav">

            <ul class="links">
  <li class=""><a href="https://robotism.me/">Notes</a></li>
  <li class=""><a href="https://robotism.me/about/">About</a></li>
</ul>

<ul class="icons">
  <li><a href="https://github.com/4lhc" class="icon fa-github" rel="nofollow"><span class="label">GitHub</span></a></li>
  <li><a href="https://www.linkedin.com/in/sreejith-pillai-2628b6155" class="icon fa-linkedin" rel="nofollow"><span class="label">Linkedin</span></a></li>
  <li><a href="https://www.researchgate.net/profile/Sreejith_S_Pillai2" class="icon fa-researchgate" rel="nofollow"><span class="label">Rg</span></a></li>
  <!--<li><a href="https://instagram.com/default" class="icon fa-instagram" rel="nofollow"><span class="label">Instagram</span></a></li>-->
</ul>


					</nav>

				<!-- Main -->
				<div id="main">
          <section class="post">
    				<header class="major">
      				<span class="date">14 Sep 2019</span>
      				<h1>Controlling ROS Turtlebot3 with Miband - Part II</h1>
      				<p>Coding a Xiaomi Miband Controller for ROS Gazebo Turtlebot3 simulation.</p>
      			</header>
      			<div class="image main"><img src="/images/controlling-ROS-robot-with-miband-hrx-2-img01.png" alt=""></div>
      			<p><p>After successfully establishing communication <a href="/blog/controlling-ROS-robot-with-miband-hrx-1/">(read Part I)</a> with the MiBand HRX, we can start writing the controller node.</p>

<p>We will start by setting up project ros package.</p>

<h3 id="1-setup">1. Setup</h3>
<p>Create a package named <code class="highlighter-rouge">x1_miband_control</code> with a dependency on rospy.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">catkin_create_pkg x1_miband_control rospy
<span class="nb">cd </span>x1_miband_control/src</code></pre></figure>

<p>We have three other runtime dependencies to make the MiBand controller work. <a href="https://github.com/dlitz/pycrypto">PyCrypto</a>, <a href="https://github.com/IanHarvey/bluepy">bluepy</a> &amp; the <a href="https://github.com/4lhc/MiBand_HRX">MiBand HRX</a> library that we created in Part I.
Once inside the <code class="highlighter-rouge">x1_miband_control/src</code> directory we can clone the dependencies. Make sure that you checkout the right versions</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">git clone <span class="nt">-n</span> https://github.com/4lhc/MiBand_HRX
<span class="nb">cd </span>MiBand_HRX
git checkout 1711a218ab66bfba25aa7de717452574301dcba5</code></pre></figure>

<p>Repeat the same for the other dependencies. From <code class="highlighter-rouge">xi_miband_control/src</code></p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">git clone <span class="nt">-n</span> https://github.com/dlitz/pycrypto
<span class="nb">cd </span>pycrypto
git checkout 7fd528d03b5eae58eef6fd219af5d9ac9c83fa50
<span class="nb">cd</span> ..
git clone <span class="nt">-n</span> https://github.com/IanHarvey/bluepy
<span class="nb">cd </span>bluepy
git checkout dc33285f31a873fab92c22e8839c44899f82b041</code></pre></figure>

<p>Bluepy and pycrypto has to be built and installed using setup.py inside their respective directories. I am yet to find a way to automate the build of these dependencies using CmakeLists.txt. Inside both bluepy &amp; pycrypto directories run,</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">python setup.py build <span class="o">&amp;&amp;</span> python setup.py install</code></pre></figure>

<p>Furthermore, I had to move <code class="highlighter-rouge">xi_miband_control/src/bluepy/bluepy</code> to <code class="highlighter-rouge">xi_miband_control/src/bluepy</code> inorder for bluepy to work.</p>

<p>Next, we will create a setup.py in out package root with the following content and uncomment the <code class="highlighter-rouge">catkin_python_setup()</code> macro in <code class="highlighter-rouge">CmakeLists.txt</code> to make sure that our dependencies get installed.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># For catkin_make</span>
<span class="kn">from</span> <span class="nn">distutils.core</span> <span class="kn">import</span> <span class="n">setup</span>
<span class="kn">from</span> <span class="nn">catkin_pkg.python_setup</span> <span class="kn">import</span> <span class="n">generate_distutils_setup</span>

<span class="c"># fetch values from package.xml</span>
<span class="n">setup_args</span> <span class="o">=</span> <span class="n">generate_distutils_setup</span><span class="p">(</span>
    <span class="n">packages</span><span class="o">=</span><span class="p">[</span><span class="s">'MiBand_HRX'</span><span class="p">,</span> <span class="s">'bluepy'</span><span class="p">,</span> <span class="s">'pycrypto'</span><span class="p">],</span>
    <span class="n">package_dir</span><span class="o">=</span><span class="p">{</span><span class="s">''</span><span class="p">:</span> <span class="s">'src'</span><span class="p">},</span>
<span class="p">)</span>

<span class="n">setup</span><span class="p">(</span><span class="o">**</span><span class="n">setup_args</span><span class="p">)</span></code></pre></figure>

<!--<div class="github-sample-reference">
  <div class="author-info">
    <a href="https://github.com/4lhc/ROS/blob/0006a7ac12131a579777117e9cc4e1e5f31f805e/learning_ws/src/x1_miband_control/setup.py">This Github Sample</a> is by <a href="https://github.com/4lhc">4lhc</a>
  </div>
  <div class="meta-info">
    learning_ws/src/x1_miband_control/setup.py <a href="https://github.com/4lhc/ROS/blob/0006a7ac12131a579777117e9cc4e1e5f31f805e/learning_ws/src/x1_miband_control/setup.py">view</a> <a href="https://raw.githubusercontent.com/4lhc/ROS/0006a7ac12131a579777117e9cc4e1e5f31f805e/learning_ws/src/x1_miband_control/setup.py">raw</a>
  </div>
</div>-->

<p>Finally, run <code class="highlighter-rouge">catkin_make</code> from the catkin workspace root to build everything.</p>

<h3 id="2-miband-controller">2. MiBand Controller</h3>

<p>We will start by importing the necessary modules. Multithreading is used to prevent the <code class="highlighter-rouge">band.start_raw_data_realtime()</code> method from blocking.
<a href="https://github.com/4lhc/ROS/blob/master/learning_ws/src/x1_miband_control/src/generic_robot.py"><code class="highlighter-rouge">generic_robot</code></a> contains a simple <code class="highlighter-rouge">Robot()</code> class definition.</p>

<p><a href="https://github.com/4lhc/ROS/blob/e8adca517d6d338cf86a63c005fb4a2c9cdcdf44/learning_ws/src/x1_miband_control/bin/miband_controller.py#L42"><code class="highlighter-rouge">vel_control()</code></a> method sets the robot’s linear x velocity to a value proportional to the pitch of the MiBand and the angular z velocity to a value proportional to MiBand’s roll. It also applies a low pass filter to the roll &amp; pitch.</p>

<p><a href="https://github.com/4lhc/ROS/blob/e8adca517d6d338cf86a63c005fb4a2c9cdcdf44/learning_ws/src/x1_miband_control/bin/miband_controller.py#L27"><code class="highlighter-rouge">start_control()</code></a> will run as long as data is available from the MiBand. If the robot crashes into a wall, the method sends a vibration alert to the MiBand.</p>

<noscript><pre>400: Invalid request</pre></noscript>
<script src="https://gist.github.com/d42bba11b870be4c5860b00256fbec27.js"> </script>

<h3 id="3-test-run">3 Test Run</h3>

<!--https://silvercircle.github.io/2017/10/10/embed-youtube-jekyll/-->

<div style="width: 80%; margin:0 auto;">

  <div class="ytcontainer">
    <iframe class="yt" allowfullscreen="" src="https://www.youtube.com/embed/Zg9SUYd6MYA"></iframe>
  </div>
</div>

<h3 id="4-next">4 Next</h3>
<p>This was a fun project. It still requires a lot of improvements. If time permits, I would like to build a game of tag, with multiple MiBand controlled robots in gazebo – would be cool!</p>
</p>
      		</section>

          <div class="comments-wrapper">
          <div id="disqus_thread"></div>
          <script>
              /**
               *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
               *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
               */

              var disqus_config = function () {
                  this.page.url = 'https://robotism.me/blog/controlling-ROS-robot-with-miband-hrx-2/';
                  <!--this.page.url = 'https://robotism.me/blog/controlling-ROS-robot-with-miband-hrx-2/';  /*Replace PAGE_URL with your page's canonical URL variable*/-->
                  <!--this.page.identifier = '/blog/controlling-ROS-robot-with-miband-hrx-2/'; /*Replace PAGE_IDENTIFIER with your page's unique identifier variable*/-->
                  this.page.identifier = 'https://robotism.me/blog/controlling-ROS-robot-with-miband-hrx-2/';
              };

              (function() {  /* dont endit below this line */
                  var d = document, s = d.createElement('script');

                  s.src = 'https://robotically.disqus.com/embed.js';

                  s.setAttribute('data-timestamp', +new Date());
                  (d.head || d.body).appendChild(s);
              })();
          </script>
          <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
        </div><!-- /.comments-wrapper -->


					<!-- Footer -->
						<footer>
              <ul class="actions">
                <li><a href="https://robotism.me/blog/" class="button">Notes</a></li>
              </ul>
						</footer>
					</div>

				<!-- Footer -->
        <footer id="footer">
  <section>
    <form id="slapform" method="POST" action="">
      <div class="field">
        <label for="name">Name</label>
        <input type="text" name="name" id="name" />
      </div>
      <div class="field">
        <label for="email">Email</label>
        <input type="text" name="slap_replyto" id="email" /> <!-- slap_replyto will set the reply-to as the submitter's email! -->
      </div>
      <div class="field">
        <label for="message">Message</label>
        <textarea name="message" id="message" rows="3"></textarea>
      </div>
      <ul class="actions">
        <li><input type="submit" value="Send Message" /></li>
      </ul>
      <input type="hidden" name="slap_redirect" value="https://robotism.me/thank-you" /> <!-- slap_redirect allows you to set a custom redirect/thank you page -->
    </form>
  </section>
  <section class="split contact">
    <section>

      <h3>Email</h3>

      <p>

      <a id="mailto" href="">Send mail</a></p>
    </section>
<script type="text/javascript" language="javascript">
<!--
// Email obfuscator script 2.1 by Tim Williams, University of Arizona
// Random encryption key feature coded by Andrew Moulden
// This code is freeware provided these four comment lines remain intact
// A wizard to generate this code is at http://www.jottings.com/obfuscator/
function testmail()
{
    coded = "vlQ3jry@Zc1QX.kAc"
  key = "rfnDz54FSptNxLEl1RmKTUgb2YO3GBsJXy6ciuwZM8ohC9Wvd7VqkQIHPe0Aja"
  shift=coded.length
  link=""
  for (i=0; i<coded.length; i++) {
    if (key.indexOf(coded.charAt(i))==-1) {
      ltr = coded.charAt(i)
      link += (ltr)
    }
    else {
      ltr = (key.indexOf(coded.charAt(i))-shift+key.length) % key.length
      link += (key.charAt(ltr))
    }
  }
document.getElementById("slapform").action = "https://api.slapform.com/"+link;
document.getElementById("mailto").href = "mailto:"+link;
}
testmail();
//-->
</script><noscript>Sorry, you need Javascript on to email me.</noscript>
    <section>
      <h3>Social</h3>
      <ul class="icons alt">
        <li><a href="https://www.linkedin.com/in/sreejith-pillai-2628b6155" rel="nofollow"><span class="label">LinkedIn</span></a></li>
        <li><a href="https://github.com/4lhc"  rel="nofollow"><span class="label">GitHub</span></a></li>
        <li><a href="https://www.researchgate.net/profile/Sreejith_S_Pillai2" rel="nofollow"><span class="label">ResearchGate</span></a></li>
      </ul>
    </section>
  </section>
</footer>
<!-- Copyright -->
<div id="copyright">
  <ul><li>&copy; HTML5 UP</li><li>Design by <a href="https://html5up.net" rel="nofollow">HTML5 UP</a></li><li>Jekyll Integration by <a href="https://slapform.com">Slapform</a> </li></ul>
</div>


			</div>

      <!-- Scripts -->
  		<!-- DYN -->
<script src="https://robotism.me/assets/js/jquery.min.js"></script>
<script src="https://robotism.me/assets/js/jquery.scrollex.min.js"></script>
<script src="https://robotism.me/assets/js/jquery.scrolly.min.js"></script>
<script src="https://robotism.me/assets/js/skel.min.js"></script>
<script src="https://robotism.me/assets/js/util.js"></script>
<script src="https://robotism.me/assets/js/main.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: [
      "MathMenu.js",
      "MathZoom.js",
      "AssistiveMML.js",
      "a11y/accessibility-menu.js"
    ],
    jax: ["input/TeX", "output/CommonHTML"],
    TeX: {
      extensions: [
        "AMSmath.js",
        "AMSsymbols.js",
        "noErrors.js",
        "noUndefined.js",
      ]
    }
  });
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script>



			<script async src="https://www.googletagmanager.com/gtag/js?id=default"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments)};
  gtag('js', new Date());

  gtag('config', 'default');
</script>


	</body>
</html>
